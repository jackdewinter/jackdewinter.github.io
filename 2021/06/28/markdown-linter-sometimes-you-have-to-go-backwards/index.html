<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="Jack De Winter" />

        <meta name="description" content="Summary¶ In my last article, I talked about elevating the extension object support in the PyMarkdown project to the same level as plugins rules. In this article, I talk about starting to work on getting rid of some long-standing issues: nested container blocks. Introduction¶ There are times in my professional …
" />
        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="markdown linter, core linter, Software Quality, " />

<meta property="og:title" content="Markdown Linter - Sometimes You Have To Go Backwards... "/>
<meta property="og:url" content="https://jackdewinter.github.io/2021/06/28/markdown-linter-sometimes-you-have-to-go-backwards/" />
<meta property="og:description" content="Summary¶ In my last article, I talked about elevating the extension object support in the PyMarkdown project to the same level as plugins rules. In this article, I talk about starting to work on getting rid of some long-standing issues: nested container blocks. Introduction¶ There are times in my professional …" />
<meta property="og:site_name" content="Jack&#39;s Digital Workbench" />
<meta property="og:article:author" content="Jack De Winter" />
<meta property="og:article:published_time" content="2021-06-28T00:00:00-07:00" />
<meta name="twitter:title" content="Markdown Linter - Sometimes You Have To Go Backwards... ">
<meta name="twitter:description" content="Summary¶ In my last article, I talked about elevating the extension object support in the PyMarkdown project to the same level as plugins rules. In this article, I talk about starting to work on getting rid of some long-standing issues: nested container blocks. Introduction¶ There are times in my professional …">

        <title>Markdown Linter - Sometimes You Have To Go Backwards...  · Jack&#39;s Digital Workbench
</title>
        <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://jackdewinter.github.io/theme/css/style.min.css?bec7d543">

        <link href="https://jackdewinter.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Jack&#39;s Digital Workbench - Full Atom Feed" />


    </head>
    <body>
        <div id="content">
            <div class="navbar navbar-static-top">
                <div class="navbar-inner">
                    <div class="container-fluid">
                        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </a>
                        <a class="brand" href="https://jackdewinter.github.io/"><span class=site-name>Jack's Digital Workbench</span></a>
                        <div class="nav-collapse collapse">
                            <ul class="nav pull-right top-menu">
                                <li >
                                    <a href=
                                       https://jackdewinter.github.io
                                    >Home</a>
                                </li>
                                <li ><a href="https://jackdewinter.github.io/categories">Categories</a></li>
                                <li ><a href="https://jackdewinter.github.io/tags">Tags</a></li>
                                <li ><a href="https://jackdewinter.github.io/archives">Archives</a></li>
                                <li><form class="navbar-search" action="https://jackdewinter.github.io/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container-fluid">
                <div class="row-fluid">
                    <div class="span1"></div>
                    <div class="span10">
<article itemscope>
<div class="row-fluid">
    <header class="page-header span10 offset2">
        <h1>
            <a href="https://jackdewinter.github.io/2021/06/28/markdown-linter-sometimes-you-have-to-go-backwards/">
                Markdown Linter - Sometimes You Have To Go Backwards...
            </a>
        </h1>
    </header>
</div>

<div class="row-fluid">
    <div class="span2 table-of-content">
        <nav>
        <h4>Contents</h4>
        <div class="toc">
<ul>
<li><a href="#summary">Summary</a></li>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#what-is-the-audience-for-this-article">What Is the Audience for This Article?</a></li>
<li><a href="#giving-it-some-context">Giving It Some Context</a></li>
<li><a href="#getting-to-work">Getting To Work</a><ul>
<li><a href="#do-the-research-first">Do The Research First</a></li>
<li><a href="#experimental-testing">Experimental Testing</a></li>
<li><a href="#isolating-the-changes">Isolating The Changes</a></li>
<li><a href="#responding-to-the-trigger">Responding To The Trigger</a></li>
<li><a href="#that-last-line">That Last Line</a></li>
</ul>
</li>
<li><a href="#echoes-of-stories-long-forgotten">Echoes of Stories Long Forgotten</a><ul>
<li><a href="#putting-that-to-work">Putting That To Work</a></li>
<li><a href="#fixing-scenarios-270-and-271">Fixing Scenarios 270 and 271</a></li>
<li><a href="#finding-the-first-issue">Finding The First Issue</a></li>
<li><a href="#making-it-right">Making It Right</a></li>
</ul>
</li>
<li><a href="#html-output-and-markdown-output-changes">HTML Output and Markdown Output Changes?</a><ul>
<li><a href="#wrapping-up">Wrapping Up</a></li>
</ul>
</li>
<li><a href="#what-was-my-experience-so-far">What Was My Experience So Far?</a></li>
<li><a href="#what-is-next">What is Next?</a></li>
</ul>
</div>
        </nav>
    </div>
    <div class="span8 article-content">
            
            
<h2 id="summary">Summary<a class="headerlink" href="#summary" title="Permanent link">¶</a></h2>
<p>In my
<a href="https://jackdewinter.github.io/2021/06/21/markdown-linter-elevating-extensions/">last article</a>, I talked
about elevating the extension object support in the PyMarkdown project to the
same level as plugins rules.  In this article, I talk about starting to work on
getting rid of some long-standing issues: nested container blocks.</p>
<h2 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permanent link">¶</a></h2>
<p>There are times in my professional career where I have written chunks of code that
I knew were going to be as near to eternal as anything is in our profession.  There
are also times that I wrote code understanding that it would be replaced in a couple of
months.  Whether it was replaced in that time frame was above my paygrade.
Because of situations like those, I try and “slant” my code a bit towards those
goals, but I inevitably try and treat both situations with the same amount of
care and respect as each other.  What changes for me is whether to code is just
<em>a prototype</em> or <em>production code</em>.</p>
<p>Yes, both of those phrases were in italics.  Why was that? Due to external pressures from
people in those higher paygrades, developers often feel the need
to take some code that was meant as a prototype and productionize it as quickly
as possible.  The request is usually to take code that we know “just worked… barely”
and code that was used for experiments and to show possibilities, and get that code ready
for public consumption as quickly as possible.  And, as with anything that is
rushed, things get lost in the process, with quality usually being the first
thing to go.</p>
<p>And as much as the PyMarkdown project is on my own time and pace, I
still occasionally find myself looking at some code that was only meant as a placeholder.
It is those times that I must remind myself that sometimes, in order to take
good steps forward, I need to take a couple of steps back.</p>
<h2 id="what-is-the-audience-for-this-article">What Is the Audience for This Article?<a class="headerlink" href="#what-is-the-audience-for-this-article" title="Permanent link">¶</a></h2>
<p>While detailed more eloquently in
<a href="https://jackdewinter.github.io/2020/04/05/what-is-the-audience-for-my-blog/#what-is-the-audience-for-my-blog">this article</a>,
my goal for this technical article is to focus on the reasoning behind my solutions,
rather that the solutions themselves.  For a full record of the solutions presented in
this article, please consult the commits that occurred between
<a href="https://github.com/jackdewinter/pymarkdown/commit/1a46d3c119a58be175a4ee642493f7e3ed2d8840">26 Jun 2021</a>
and
<a href="https://github.com/jackdewinter/pymarkdown/commit/40c1333324e1927b51d9800e3957a893077e6fa9">27 Jun 2021</a>.</p>
<h2 id="giving-it-some-context">Giving It Some Context<a class="headerlink" href="#giving-it-some-context" title="Permanent link">¶</a></h2>
<p>I am going to start this article with a set of statements that I believe sums
up my work on this project.  The first is that writing a Markdown parser is hard.
Not impossibly hard, but hard enough.  If there is any doubt about how hard it
is, click on <a href="https://johnmacfarlane.net/babelmark2/?text=%3E%3E+one%0A%3E%3E%0A%3E%3E++++two">this link</a>
and count the number of different interpretations of that simple Markdown document.
Each set of results is another way in which Markdown was interpreted by someone
writing a parser.  Each one is another road taken by another set of developers.</p>
<p>Then bring into that mix, the <a href="https://github.github.com/gfm/">GitHub Flavored Markdown specification</a>
and the reference implementations of the <a href="https://spec.commonmark.org/">CommonMark family of parsers</a>.
These efforts try to bring those different roads together by providing a single
specification, a single answer for questions that previously caused parser
developers to take divergent roads.  Even better, it provides
a set of examples that parser developers can test against. The downside of this
is that there is now a standard that implementors must measure up to, otherwise
they cannot claim compliance with that standard.  That is of course, if they
decide that they want their parser to be <em>GFM compliant</em>.</p>
<p>And then there are people like me that want a grammar checking or
linting ability for their Markdown documents.  I decided to work on this project because
I want to bring the same kind of “sanity” to my Markdown documents that I bring
to my source code.  For Python there is <code>flake8</code> and <code>pylint</code>, and for Java there
is <code>PMD</code> and <code>checkstyle</code>.  So, why can I not have a similar linter for Markdown?
From my point of view, it was a niche that
needed to be filled, and I had an interest in learning more about Python and
addressing that niche.</p>
<p>Writing a GFM compliant Markdown linter adds yet another level of complexity to
that already difficult process. Not only does the project have to pass the qualifications
for writing a compliant parser, but I need to be able to be extremely confident
that the token stream the parser produces is correct.
As the PyMarkdown project allows for rules to be written that analyze that token
stream, everything needs to be reported properly and cleanly, including whitespace.
If the token stream is off, the rules that execute on that token stream are off.
So I need to be very confident about the accuracy of the token stream.</p>
<p>To put it bluntly, Markdown parser developers only worry about whether the HTML they
output looks right.  As a Markdown linter developer, I worry about whether the output
looks right, whether the rules are coded right, and whether the tokens used to power
those rules are right. And that takes a lot of effort to get right!</p>
<h2 id="getting-to-work">Getting To Work<a class="headerlink" href="#getting-to-work" title="Permanent link">¶</a></h2>
<p>And so, this week I decided to start tackling one of the issues I have been
avoiding for at least six months, if not longer: nested container blocks.</p>
<p>At the start of this week’s work, I knew that this work was going to be split
into multiple blocks of work.  I was not sure how many at the outset, but I knew
it was going to be multiple blocks.</p>
<h3 id="do-the-research-first">Do The Research First<a class="headerlink" href="#do-the-research-first" title="Permanent link">¶</a></h3>
<p>To be clear, the parser was not broken when I went to do this work, nor was
it cleanly working.  It was kind of working and kind of not working.  Yeah, those statements
are a bit fuzzy, so let me bring it into context.  The parsing of some of the
rudimentary nesting all hinged
on one specific line of code in the <code>__handle_block_quote_section</code> function:</p>
<div class="highlight"><pre><span></span><span class="n">forced_close_until_index</span> <span class="o">=</span> <span class="n">possible_list_start_index</span>
</pre></div>
<p>It was a kludge, I admit, but it was a decent kludge that had worked well.  The
usual metric that I use for things like that are:</p>
<ul>
<li>Are the scenario tests passing?</li>
<li>Are they maintainable?</li>
</ul>
<p>The answer to the first question was yes, every scenario test was passing.  I was
initially hesitant to initially answer the second question, as I knew that
very few examples dealt with these kinds of scenarios.  Because of that, I thought
that I had something in there that was decent, otherwise the scenario tests that
I already head would not have been passing.  But then I started to look at the
nesting blocks code more closely.  After a bit of examination, I realized that I
had used code that was more of a sledgehammer than an artfully crafted tool.</p>
<p>Let me explain that comparison a bit more.  I am not sure when I added that
exact line and for what reason, but its intent is clear to me.  The next time
that the close function is called, that variable will be passed into the
close function.  That will tell the close function to force a close, and to
only stop when that specific index is reached.  There is no finesse, no fine
tuning, just a simple removal until that index is hit.  And just by looking
at the code, I could tell there would be issues.   I was concerned about
the maintainability of that code going into this refactoring task.</p>
<p>I had solved that issue with a sledgehammer, and I was not happy about that.
I knew I could do better; I just needed some time to figure out how.  This
was a good time, so I “gave” myself the time I needed to think it through
properly.</p>
<h3 id="experimental-testing">Experimental Testing<a class="headerlink" href="#experimental-testing" title="Permanent link">¶</a></h3>
<p>Taking some time to get to know the code better, one thing became very evident. As
soon as I started experimenting with different values, the <code>test_block_quotes_extra_02a</code>
series of scenario tests started failing.  Nothing else, just those scenario tests.
That was good news!  That meant that the impact of this fix was relatively
self-contained.  When I thought about it, it was also bad news as the series
of tests that failed were all extra tests.  That probably meant that I was
going to have get creative near the end of this series of tasks to ensure
there was good coverage for all these scenarios, but that was a task for later.</p>
<p>As I looked at that set of tests, I noticed another thing that the tests had
in common: they were all scenarios in which a double Block Quote element was
followed by a start List Block element. Even as I played around with changing
other pieces of the nesting code, the only things that seemed to be impacted
were those tests.  From where I was, that was a good observation to make!</p>
<h3 id="isolating-the-changes">Isolating The Changes<a class="headerlink" href="#isolating-the-changes" title="Permanent link">¶</a></h3>
<p>Given the above information and a set of scenario tests that I needed to
get passing again, I started at the beginning: with the trailing List Block
element.  And for the initial scenario tests, I chose <code>test_block_quotes_extra_02ax</code>
which had a Markdown document of:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="nv">start</span>
<span class="o">&gt;</span> <span class="o">-</span> <span class="nv">quote</span>
<span class="o">&gt;</span>
<span class="o">&gt;</span> <span class="k">end</span>
</pre></div>
<p>Looking at that Markdown and the source code,
I was confident that I was going to need to keep track of that
List Block element, so I added the following line to the start of the
<code>parse_line_for_container_blocks</code> function:</p>
<div class="highlight"><pre><span></span><span class="n">parser_state</span><span class="o">.</span><span class="n">nested_list_start</span> <span class="o">=</span> <span class="bp">None</span>
</pre></div>
<p>This ensured that every time I started to look for a new container block, I
would start with a clean slate.</p>
<p>Then came the hard part: defining what set that variable and when.  Using
the information I had, I noticed that the token stream was correct until
the point where the last line was encountered.  It was then that things
went haywire.  So, taking a stab at it, I added the following three
lines, with tons of debugging around it to test my theories:</p>
<div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">this_bq_count</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">parser_state</span><span class="o">.</span><span class="n">token_stack</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="n">parser_state</span><span class="o">.</span><span class="n">token_stack</span><span class="p">[</span><span class="n">this_bq_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">is_list</span>
        <span class="ow">and</span> <span class="n">adjusted_text_to_parse</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="p">):</span>
        <span class="o">...</span>
        <span class="n">parser_state</span><span class="o">.</span><span class="n">nested_list_start</span> <span class="o">=</span> <span class="n">parser_state</span><span class="o">.</span><span class="n">token_stack</span><span class="p">[</span>
            <span class="n">this_bq_count</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="p">]</span>
</pre></div>
<p>I put lots of debug in there, and kept in in there, as I was not sure what
I was going to need for the other nested cases that I knew were going to follow.  </p>
<p>Following through with the information that I had, I knew that I needed
to look for cases where a series of Block Quote elements were followed
by another container element, the List Block element.  Once I had that,
I wanted to confirm that the following element was indeed a list, and that
the line being processed was not a blank line (after the initial Block
Quote characters were removed).  At that point, I was comfortable setting
the <code>nested_list_start</code> member variable to indicate that we had one of
those messy nested container situations to deal with.</p>
<p>And to be totally clear, this code was added as a step forward, not
a final solution.  I could already think up some weird combinations
in my head that would make this fail, but they would come later.
At that point, I was simply happy that I identified the list start that
was causing all the commotion.</p>
<h3 id="responding-to-the-trigger">Responding To The Trigger<a class="headerlink" href="#responding-to-the-trigger" title="Permanent link">¶</a></h3>
<p>Now that I had the trigger, I needed the code to respond to that trigger.
Having looked through the code multiple times in the last week, there
was one function that I knew was the nexus of all things nested:
the <code>__handle_nested_container_blocks</code> function.  This is the function
that helps handle the recursion that can come with handling nested
container blocks.</p>
<p>But when I specifically investigated the code handling a List element
within a Block Quote element, all I saw was this one statement:</p>
<div class="highlight"><pre><span></span><span class="n">adj_line_to_parse</span> <span class="o">=</span> <span class="n">adj_line_to_parse</span><span class="p">[</span>
    <span class="n">end_container_indices</span><span class="o">.</span><span class="n">block_index</span> <span class="p">:</span>
<span class="p">]</span>
</pre></div>
<p>I knew that would not handle the scenarios properly.  So, after a lot of
thinking and experimenting, I changed that code to:</p>
<div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">parser_state</span><span class="o">.</span><span class="n">nested_list_start</span><span class="p">:</span>
    <span class="n">x_tokens</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">parser_state</span><span class="o">.</span><span class="n">close_open_blocks_fn</span><span class="p">(</span>
        <span class="n">parser_state</span><span class="p">,</span>
        <span class="n">include_lists</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser_state</span><span class="o">.</span><span class="n">token_document</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">x_tokens</span><span class="p">)</span>
</pre></div>
<p>Essentially, if the parser was in a scenario where it had a Block Quote
element that contains a List Block element, it needed to close that
List Block element.  This was not the end goal, but a first step.
I knew that this had started me moving in the right direction, and that
was what was important.</p>
<p>Looking at the third line and the GFM specification, I realized that
the Block Quote element was terminating itself as soon as it encountered
the third line.  Block Quote elements get terminated right away with Blank
Lines, but List Block elements only get terminated when a non-compliant
text line is encountered.  And according to the parser, it was still within
the List Block element created on line two. I needed to fix that next.</p>
<p>To address that, I changed up the code a bit to make sure that the
List Block element stayed open when faced with a Blank Line element in this
scenario. That is when that above code changed into:</p>
<div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">parser_state</span><span class="o">.</span><span class="n">nested_list_start</span> <span class="ow">and</span> <span class="n">adj_line_to_parse</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="n">parser_state</span><span class="o">.</span><span class="n">token_document</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">is_blank_line</span>
    <span class="p">):</span>
        <span class="n">x_tokens</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">parser_state</span><span class="o">.</span><span class="n">close_open_blocks_fn</span><span class="p">(</span>
            <span class="n">parser_state</span><span class="p">,</span>
            <span class="n">include_lists</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">parser_state</span><span class="o">.</span><span class="n">token_document</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">x_tokens</span><span class="p">)</span>
</pre></div>
<p>This moved the closing of the block quote down to the last line in the document,
where it belonged.   Now, when that document was processed, it only closed
the List Block element on the last line of the document.  That was great.</p>
<p>The only problem left after that change was that the Blank Line tokens were appearing
inside of the List Block element instead of outside of the List Block element.
As any concept of a token stream is not present in the GFM specification,
I had to read between the lines to answer this question: do the Blank Line
tokens belong before the List Block element or after the List Block element?</p>
<p>I thought about this long and hard, but in the end, I did not feel like
it made any sense for the List Block element to contain those Blank Line
tokens.  Looking at the specification, I read how a list’s looseness
determined how it was presented in the final HTML output.  And when
I looked at the HTML output for those test scenarios, I saw output
that did not indicate that the looseness  was being impacted by those
Blank Line tokens.</p>
<p>Given that observation, I changed the code once again, arriving at the following
code:</p>
<div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">parser_state</span><span class="o">.</span><span class="n">nested_list_start</span> <span class="ow">and</span> <span class="n">adj_line_to_parse</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="n">parser_state</span><span class="o">.</span><span class="n">token_document</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">is_blank_line</span>
    <span class="p">):</span>
        <span class="n">y_tokens</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="n">parser_state</span><span class="o">.</span><span class="n">token_document</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">is_blank_line</span><span class="p">:</span>
            <span class="n">y_tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parser_state</span><span class="o">.</span><span class="n">token_document</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">del</span> <span class="n">parser_state</span><span class="o">.</span><span class="n">token_document</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">x_tokens</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">parser_state</span><span class="o">.</span><span class="n">close_open_blocks_fn</span><span class="p">(</span>
            <span class="n">parser_state</span><span class="p">,</span>
            <span class="n">include_lists</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">parser_state</span><span class="o">.</span><span class="n">token_document</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">x_tokens</span><span class="p">)</span>
        <span class="n">parser_state</span><span class="o">.</span><span class="n">token_document</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">y_tokens</span><span class="p">)</span>
</pre></div>
<p>With that in place, all the original tests were passing, but something was still
bugging me.  It was that last line.  I knew I needed to do something about it.</p>
<h3 id="that-last-line">That Last Line<a class="headerlink" href="#that-last-line" title="Permanent link">¶</a></h3>
<p>With all the existing tests passing, I took a look at that last line in
the Markdown documents and had one question for myself: what if that line was
a valid List Block element continuation?  With that, the <code>test_block_quotes_extra_02ae</code>
function was created.  This was simply a variant of the main Markdown test scenario,
but with a final line that continued the list, rather than end it:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="nv">start</span>
<span class="o">&gt;</span> <span class="o">-</span> <span class="nv">quote</span>
<span class="o">&gt;</span>
<span class="o">&gt;</span>   <span class="k">end</span>
</pre></div>
<p>It took me about twenty minutes to get it right, but in the end, the code
that had to change to accommodate that new scenario was small:</p>
<div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">parser_state</span><span class="o">.</span><span class="n">nested_list_start</span> <span class="ow">and</span> <span class="n">adj_line_to_parse</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
    <span class="n">start_index</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">ParserHelper</span><span class="o">.</span><span class="n">extract_whitespace</span><span class="p">(</span>
        <span class="n">adj_line_to_parse</span><span class="p">,</span> <span class="mi">0</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span>
        <span class="n">parser_state</span><span class="o">.</span><span class="n">token_document</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">is_blank_line</span>
        <span class="ow">and</span> <span class="p">(</span><span class="n">end_container_indices</span><span class="o">.</span><span class="n">block_index</span> <span class="o">+</span> <span class="n">start_index</span><span class="p">)</span>
        <span class="o">&lt;</span> <span class="n">parser_state</span><span class="o">.</span><span class="n">nested_list_start</span><span class="o">.</span><span class="n">indent_level</span>
    <span class="p">):</span>
</pre></div>
<p>It was now that I could look back at these scenarios and feel that the
code was now maintainable. I was not really scared about changing the code
before, but I was concerned.  Now I was confident that the code was in a
good place to allow any changes to be made.</p>
<h2 id="echoes-of-stories-long-forgotten">Echoes of Stories Long Forgotten<a class="headerlink" href="#echoes-of-stories-long-forgotten" title="Permanent link">¶</a></h2>
<p>I remember a story that someone told me a long time ago that went something like this:</p>
<blockquote>
<p>A machine in a factory is not working.  As much as the workers try, they cannot
get it to work.  After a lot of frustrating effort, one of the workers suggest
to management that they give a shout to the old worker who, after working at
the factory for 40 years, just retired earlier that year. With every other idea
not working, the management of the factory eventually decide to give him a call.</p>
<p>Early the next day, the old worker shows up and is shown to the machine by the
management.  He looks and prods at the machine for a good hour before he turns to
them saying “I am confident I can fix the machine, but I want 1 million dollars
to do so. I know you need to talk about it, so let me know when you have made
up your mind.”  </p>
<p>Time goes by, and the management is frustrated.  They ask the workers
that are there why they cannot fix the machine.  Those workers just shrug.  “We
did not work here for our entire lives, like he did! He knows that machine better
than he knows his own kids!” being their response.  Management is in a tight
situation.  They are losing one hundred thousand dollars for each day that
the machine is not working.  They need something in this situation to give,
or they will soon be out of business.</p>
<p>A week later, the management looks at their numbers, calculating that they
can minimize their losses if they can just get the old worker to fix the machine.
They give the old worker a call, and he comes in the next morning.  After they
give him a cashier’s check for the money he asked for, he goes to the machine,
takes out a small screwdriver, and makes three small adjustments to the machine
in less than 30 second before standing up.  Walking over to the power switch
for the machine, he turns it on, and it begins to work.  The machine works so
well, the other worker could have sworn it had just been delivered from the factory.</p>
<p>Management is outraged.  “We want that check back!” they say.  “You conned us.
We would have never paid one million dollars for less than one minutes worth
of work! We will sue you.”</p>
<p>The old man smiled back at them.  “Please, go ahead.  I never said that I was
charging one million dollars for the work that I did.  I was charging one
million dollars for the knowledge required to do the work that I did!  I am
sure any sane judge would see it that way too!”</p>
</blockquote>
<p>The moral of the story?  Knowledge is power, and timing is everything.</p>
<h3 id="putting-that-to-work">Putting That To Work<a class="headerlink" href="#putting-that-to-work" title="Permanent link">¶</a></h3>
<p>The work that was done in the previous section was not done to directly fix
any of the issues that I wanted to fix.  It was done to allow me the
latitude to make those fixes that I knew I needed to do later.  Just like
that old worker, I knew that if I wanted to clean up the nested container
scenarios, I first needed to ensure that the parser was running cleanly.
With what was there before I cleaned it up, I was confident that it would
have caused me more effort to work around it than to fix it properly.</p>
<p>Basically, I believe that knowing that I needed to do that work and scheduling
it right before I handled the issues I wanted to fix was a smart move. Did it
take time? Yes.  But did it save time in the long run?  Inevitably.</p>
<h3 id="fixing-scenarios-270-and-271">Fixing Scenarios 270 and 271<a class="headerlink" href="#fixing-scenarios-270-and-271" title="Permanent link">¶</a></h3>
<p>Spending the time fixing the already passing scenario tests for nested containers
also had a nice side effect of letting me be more familiar with that code and
the resultant token streams. That helped with what I did next.</p>
<p>To set the stage for the rest of this section, what these tests were parsing
were all variations on this piece of Markdown:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="mi">1</span><span class="p">.</span> <span class="o">&gt;</span> <span class="n">Blockquote</span>
<span class="n">continued</span> <span class="n">here</span><span class="p">.</span>
</pre></div>
<p>Nothing complicated, just nested containers, going back and forth between
Block Quote elements, List Block elements, and back to Block Quote elements.</p>
<h3 id="finding-the-first-issue">Finding The First Issue<a class="headerlink" href="#finding-the-first-issue" title="Permanent link">¶</a></h3>
<p>When I started looking at the token stream for
Scenario 270, I quickly noticed that something was missing: the inner Block
Quote token was not there.  Enabling debug mode, I quickly traced through the
<code>__handle_block_quote_section</code> function until I hit this part of that function
for the inner Block Quote element:</p>
<div class="highlight"><pre><span></span>    <span class="p">(</span>
        <span class="n">container_level_tokens</span><span class="p">,</span>
        <span class="n">stack_bq_count</span><span class="p">,</span>
        <span class="n">requeue_line_info</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">=</span> <span class="n">BlockQuoteProcessor</span><span class="o">.</span><span class="n">__ensure_stack_at_level</span><span class="p">(</span>
        <span class="n">parser_state</span><span class="p">,</span>
        <span class="n">this_bq_count</span><span class="p">,</span>
        <span class="n">stack_bq_count</span><span class="p">,</span>
        <span class="n">extracted_whitespace</span><span class="p">,</span>
        <span class="n">position_marker</span><span class="p">,</span>
        <span class="n">original_start_index</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>
<p>It was here that I noticed that the <code>this_bq_count</code> variable was set to <code>1</code>.
Doing some digging, what I determined was that in making the parsing of
the Block Quote element easier in other cases, I was only keeping track
of consecutive cases of Block Quote elements.  The first Block Quote element
and the Ordered List element were both recognized, but when it hit this
function, it thought the right number of Block Quote tokens were already
addressed.</p>
<h3 id="making-it-right">Making It Right<a class="headerlink" href="#making-it-right" title="Permanent link">¶</a></h3>
<p>It took a bit of effort to make these tests work right, but it
was completed within around ninety minutes.  Because of the existing
logic, I knew that I needed to create a variable like <code>container_start_bq_count</code>,
set it at the start of the <code>__look_for_container_blocks</code> function,
and pass it into the Block Quote element handling.  I felt that rewriting
a lot more code was not the best thing to do, so I just needed to work with
the information that I had.  Given that scenario, I also felt that I could
adjust for it by adjusting the <code>this_bq_count</code> variable to include the number
of any previous Block Quote elements:</p>
<div class="highlight"><pre><span></span>    <span class="k">if</span> <span class="n">container_start_bq_count</span><span class="p">:</span>
        <span class="n">this_bq_count</span> <span class="o">+=</span> <span class="n">container_start_bq_count</span>
</pre></div>
<p>From there, things were looking better, but the extracted whitespace was
off, adding more whitespace than was needed when creating the new
Block Quote token.  That also was a quick fix, adding this code:</p>
<div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">container_start_bq_count</span><span class="p">:</span>
    <span class="n">extracted_whitespace</span> <span class="o">=</span> <span class="n">extracted_whitespace</span><span class="p">[</span><span class="n">original_start_index</span><span class="p">:]</span>
</pre></div>
<p>Finally, everything was looking good except for the other whitespace part
of the token: the leading whitespace.  But as with the previous fix,
this one was easy to spot and easy to do, changing:</p>
<div class="highlight"><pre><span></span><span class="n">found_bq_stack_token</span> <span class="o">=</span> <span class="n">parser_state</span><span class="o">.</span><span class="n">token_stack</span><span class="p">[</span><span class="n">stack_index</span><span class="p">]</span>
<span class="n">found_bq_stack_token</span><span class="o">.</span><span class="n">matching_markdown_token</span><span class="o">.</span><span class="n">add_leading_spaces</span><span class="p">(</span>
    <span class="n">removed_text</span>
<span class="p">)</span>
</pre></div>
<p>to:</p>
<div class="highlight"><pre><span></span><span class="n">adjusted_removed_text</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">removed_text</span><span class="p">[</span><span class="n">original_start_index</span><span class="p">:]</span>
    <span class="k">if</span> <span class="n">container_start_bq_count</span> <span class="ow">and</span> <span class="n">original_start_index</span>
    <span class="k">else</span> <span class="n">removed_text</span>
<span class="p">)</span>
<span class="n">found_bq_stack_token</span> <span class="o">=</span> <span class="n">parser_state</span><span class="o">.</span><span class="n">token_stack</span><span class="p">[</span><span class="n">stack_index</span><span class="p">]</span>
<span class="n">found_bq_stack_token</span><span class="o">.</span><span class="n">matching_markdown_token</span><span class="o">.</span><span class="n">add_leading_spaces</span><span class="p">(</span>
    <span class="n">adjusted_removed_text</span>
<span class="p">)</span>
</pre></div>
<h2 id="html-output-and-markdown-output-changes">HTML Output and Markdown Output Changes?<a class="headerlink" href="#html-output-and-markdown-output-changes" title="Permanent link">¶</a></h2>
<p>While there were changes to both the HTML generator and the Markdown
generator, both changes were small.  It was getting the token stream
to be correct that allowed those changes to remain small.</p>
<h3 id="wrapping-up">Wrapping Up<a class="headerlink" href="#wrapping-up" title="Permanent link">¶</a></h3>
<p>After double and triple checking the changes that I made for scenario test 270,
I was not surprised to see that scenario test 271 was working as well. There
was only a small difference between the two, and that difference was on
the second line.  Once the inner Block Quote elements was properly inserted,
the rest of both scenario tests, just fell into place.</p>
<h2 id="what-was-my-experience-so-far">What Was My Experience So Far?<a class="headerlink" href="#what-was-my-experience-so-far" title="Permanent link">¶</a></h2>
<p>I am not sure where to place how I feel about these changes on a scale.
I did not feel like I was making amends for leaving that kludge in there.
But I also know that I wish I had dealt with that kludge a long time ago.
If anything, I guess I was a bit sad that I did not take the time to fix
that issue when I needed to, leaving it until now.</p>
<p>But that is how things often work with software development.  You approach
things with the best of intentions, and sometimes you must make hard choices.
In this case, I did not make a bad choice, just not a pretty choice.  It
worked for what it needed to do, but if left in there, it would have incurred
more cost in the long run.</p>
<p>From my point of view, my feelings aside, I believe I made the right choice
at the time.  These changes affect less than 8 tests out of 2700+ tests,
which is a very small percentage.  Should I have delayed the work I was
doing just to fix those tests?  While my feelings and ego may say no,
in hindsight it looks like it was within the range of right
things to do.  It is made even more so by the fact that I understood this
at the time I made that decision and added an item to the issues list
to return to it.</p>
<p>This really was a case of taking a couple of steps back, to ensure I
can take these forward steps without worrying about tripping over bad
code.  And that is a good thing!</p>
<h2 id="what-is-next">What is Next?<a class="headerlink" href="#what-is-next" title="Permanent link">¶</a></h2>
<p>Since I have started down the road of addressing these nesting issues, next
week is going to be about continuing, and hopefully completing that work.
Stay tuned!</p>


             
 
                <p id="post-share-links">
    Like this post? Share on:
    <a href="https://twitter.com/intent/tweet?text=Markdown%20Linter%20-%20Sometimes%20You%20Have%20To%20Go%20Backwards...&url=https%3A//jackdewinter.github.io/2021/06/28/markdown-linter-sometimes-you-have-to-go-backwards/&hashtags=markdown-linter,core-linter" target="_blank" rel="nofollow noopener noreferrer" title="Share on Twitter">Twitter</a>
    ❄
    <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A//jackdewinter.github.io/2021/06/28/markdown-linter-sometimes-you-have-to-go-backwards/" target="_blank" rel="nofollow noopener noreferrer" title="Share on Facebook">Facebook</a>
    ❄
    <a href="mailto:?subject=Markdown%20Linter%20-%20Sometimes%20You%20Have%20To%20Go%20Backwards...&amp;body=https%3A//jackdewinter.github.io/2021/06/28/markdown-linter-sometimes-you-have-to-go-backwards/" target="_blank" rel="nofollow noopener noreferrer" title="Share via Email">Email</a>
    </p>

            
            






<section>
    <h6 style="display:none;">Comments</h6>
    <p id="comment-message">So what do you think? Did I miss something? Is any part unclear? Leave your comments below. </p>

    <div class="accordion" id="accordion2">
        <div class="accordion-group">
            <div class="accordion-heading">
                <a class="accordion-toggle disqus-comment-count comment-count"
                   data-toggle="collapse"
                   data-parent="#accordion2"
                   href="https://jackdewinter.github.io/2021/06/28/markdown-linter-sometimes-you-have-to-go-backwards/#comment_thread"
                   id="comment-accordion-toggle">
                    Comments
                </a>
            </div>
            <div id="comment_thread" class="accordion-body collapse">
                <div class="accordion-inner">
                    <div class="comments">

                        <script src="https://utteranc.es/client.js"
        data-repo="jackdewinter/jackdewinter.github.io"
        data-issue-term="markdown-linter-beta-release-c"
        data-label="Comments"
        data-theme="github-light"
        crossorigin="anonymous"
        async>
</script>

                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

            <hr/>
            <aside>
            <nav>
            <ul class="articles-timeline">
                <li class="previous-article">« <a href="https://jackdewinter.github.io/2021/06/21/markdown-linter-elevating-extensions/" title="Previous: Markdown Linter - Elevating Extensions">Markdown Linter - Elevating Extensions</a></li>
                <li class="next-article"><a href="https://jackdewinter.github.io/2021/07/12/markdown-linter-full-of-sound-and-fury/" title="Next: Markdown Linter - Full Of Sound And Fury">Markdown Linter - Full Of Sound And Fury</a> »</li>
            </ul>
            </nav>
            </aside>
        </div>
        <section id="article-sidebar" class="span2">
    <h4>Reading Time</h4>
    <p>~17 min read</p>
            <h4>Published</h4>
            <time itemprop="dateCreated" datetime="2021-06-28T00:00:00-07:00">Jun 28, 2021</time>
        <h4>Markdown Linter Beta Release</h4>
    <ul class="multi-parts-list">
            <li >
            <a href="https://jackdewinter.github.io/2021/06/14/markdown-linter-getting-stuff-done/" title="Markdown Linter - Getting Stuff Done">Part 1: Markdown Linter - Getting Stuff Done</a>
            </li>
            <li >
            <a href="https://jackdewinter.github.io/2021/06/21/markdown-linter-elevating-extensions/" title="Markdown Linter - Elevating Extensions">Part 2: Markdown Linter - Elevating Extensions</a>
            </li>
            <li  class="active-part">
            Part 3: Markdown Linter - Sometimes You Have To Go Backwards...
            </li>
            <li >
            <a href="https://jackdewinter.github.io/2021/07/12/markdown-linter-full-of-sound-and-fury/" title="Markdown Linter - Full Of Sound And Fury">Part 4: Markdown Linter - Full Of Sound And Fury</a>
            </li>
            <li >
            <a href="https://jackdewinter.github.io/2021/08/02/markdown-linter-making-progress-on-new-rules/" title="Markdown Linter - Making Progress On New Rules">Part 5: Markdown Linter - Making Progress On New Rules</a>
            </li>
            <li >
            <a href="https://jackdewinter.github.io/2021/07/26/markdown-linter-getting-back-to-new-rules/" title="Markdown Linter - Getting Back To New Rules">Part 6: Markdown Linter - Getting Back To New Rules</a>
            </li>
            <li >
            <a href="https://jackdewinter.github.io/2021/08/09/markdown-linter-continuing-progress-on-implementing-new-rules/" title="Markdown Linter - Continuing Progress On Implementing New Rules">Part 7: Markdown Linter - Continuing Progress On Implementing New Rules</a>
            </li>
            <li >
            <a href="https://jackdewinter.github.io/2021/08/16/markdown-linter-dealing-with-rule-md027/" title="Markdown Linter - Dealing With Rule Md027">Part 8: Markdown Linter - Dealing With Rule Md027</a>
            </li>
            <li >
            <a href="https://jackdewinter.github.io/2021/08/23/markdown-linter-three-more-rules/" title="Markdown Linter - Three More Rules">Part 9: Markdown Linter - Three More Rules</a>
            </li>
            <li >
            <a href="https://jackdewinter.github.io/2021/08/30/markdown-linter-another-three-done/" title="Markdown Linter - Another Three Done!">Part 10: Markdown Linter - Another Three Done!</a>
            </li>
            <li >
            <a href="https://jackdewinter.github.io/2021/09/13/markdown-linter-back-to-work/" title="Markdown Linter - Back To Work!">Part 11: Markdown Linter - Back To Work!</a>
            </li>
            <li >
            <a href="https://jackdewinter.github.io/2021/09/20/markdown-linter-race-to-the-finish/" title="Markdown Linter - Race To The Finish">Part 12: Markdown Linter - Race To The Finish</a>
            </li>
    </ul>
            <h4>Category</h4>
            <a class="category-link" href="https://jackdewinter.github.io/categories#software-quality-ref">Software Quality</a>
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article">
                <li><a href="https://jackdewinter.github.io/tags#core-linter-ref">core linter
                    <span>70</span>
</a></li>
                <li><a href="https://jackdewinter.github.io/tags#markdown-linter-ref">markdown linter
                    <span>88</span>
</a></li>
            </ul>
<h4>Stay in Touch</h4>
<div id="sidebar-social-link">
    <a href="https://github.com/jackdewinter" title="github-alt" target="_blank" rel="nofollow noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="GitHub" role="img" viewBox="0 0 512 512"><rect width="512" height="512" rx="15%" fill="#1B1817"/><path fill="#fff" d="M335 499c14 0 12 17 12 17H165s-2-17 12-17c13 0 16-6 16-12l-1-50c-71 16-86-28-86-28-12-30-28-37-28-37-24-16 1-16 1-16 26 2 40 26 40 26 22 39 59 28 74 22 2-17 9-28 16-35-57-6-116-28-116-126 0-28 10-51 26-69-3-6-11-32 3-67 0 0 21-7 70 26 42-12 86-12 128 0 49-33 70-26 70-26 14 35 6 61 3 67 16 18 26 41 26 69 0 98-60 120-117 126 10 8 18 24 18 48l-1 70c0 6 3 12 16 12z"/></svg>
    </a>
    <a href="https://www.linkedin.com/in/jackdewinter/" title="linkedin" target="_blank" rel="nofollow noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="LinkedIn" role="img" viewBox="0 0 512 512" fill="#fff"><rect width="512" height="512" rx="15%" fill="#0077b5"/><circle cx="142" cy="138" r="37"/><path stroke="#fff" stroke-width="66" d="M244 194v198M142 194v198"/><path d="M276 282c0-20 13-40 36-40 24 0 33 18 33 45v105h66V279c0-61-32-89-76-89-34 0-51 19-59 32"/></svg>
    </a>
    <a href="https://jackdewinter.github.io/feeds/all.atom.xml" title="" target="_blank" rel="nofollow noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="RSS" role="img" viewBox="0 0 512 512"><rect width="512" height="512" rx="15%" fill="#f80"/><circle cx="145" cy="367" r="35" fill="#fff"/><path fill="none" stroke="#fff" stroke-width="60" d="M109 241c89 0 162 73 162 162M109 127c152 0 276 124 276 276"/></svg>
    </a>
</div>
            





            





        </section>
</div>
</article>
                    </div>
                    <div class="span1"></div>
                </div>
            </div>
        </div>
<footer>
    <div>
        
&copy; Copyright 2021 by Jack De Winter and licensed under a <a rel="license"
  href="http://creativecommons.org/licenses/by/4.0/">
  <img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/80x15.png" />
  Creative Commons Attribution 4.0 International License</a>.

    </div>




    <div id="fpowered">
        Powered by: <a href="http://getpelican.com/" title="Pelican Home Page" target="_blank" rel="nofollow noopener noreferrer">Pelican</a>
        Theme: <a href="https://elegant.oncrashreboot.com/" title="Theme Elegant Home Page" target="_blank" rel="nofollow noopener noreferrer">Elegant</a>
    </div>
</footer>            <script src="//code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

    <script>
    (function () {
        if (window.location.hash.match(/^#comment-\d+$/)) {
            $('#comment_thread').collapse('show');
        }
    })();
    window.onhashchange=function(){
        if (window.location.hash.match(/^#comment-\d+$/))
            window.location.reload(true);
    }
    $('#comment_thread').on('shown', function () {
        var link = document.getElementById('comment-accordion-toggle');
        var old_innerHTML = link.innerHTML;
        $(link).fadeOut(200, function() {
            $(this).text('Click here to hide comments').fadeIn(200);
        });
        $('#comment_thread').on('hidden', function () {
            $(link).fadeOut(200, function() {
                $(this).text(old_innerHTML).fadeIn(200);
            });
        })
    })
</script>

    </body>
    <!-- Theme: Elegant built for Pelican
        License : MIT -->
</html>