<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="Jack De Winter" />

        <meta name="description" content="Summary¶ In my last article, I completed the addition of proper support for line and column numbers for the text token and emphasis tokens by finishing the consistency checks. In this article, I talk about the efforts and issues required to finish implementing the line and column numbers for the …
" />
        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="markdown linter, core linter, Software Quality, " />

<meta property="og:title" content="Markdown Linter - Adding Remaining Inline Tokens "/>
<meta property="og:url" content="https://jackdewinter.github.io/2020/09/21/markdown-linter-adding-remaining-inline-tokens/" />
<meta property="og:description" content="Summary¶ In my last article, I completed the addition of proper support for line and column numbers for the text token and emphasis tokens by finishing the consistency checks. In this article, I talk about the efforts and issues required to finish implementing the line and column numbers for the …" />
<meta property="og:site_name" content="Jack&#39;s Digital Workbench" />
<meta property="og:article:author" content="Jack De Winter" />
<meta property="og:article:published_time" content="2020-09-21T00:00:00-07:00" />
<meta name="twitter:title" content="Markdown Linter - Adding Remaining Inline Tokens ">
<meta name="twitter:description" content="Summary¶ In my last article, I completed the addition of proper support for line and column numbers for the text token and emphasis tokens by finishing the consistency checks. In this article, I talk about the efforts and issues required to finish implementing the line and column numbers for the …">

        <title>Markdown Linter - Adding Remaining Inline Tokens  · Jack&#39;s Digital Workbench
</title>
        <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://jackdewinter.github.io/theme/css/style.min.css?bec7d543">

        <link href="https://jackdewinter.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Jack&#39;s Digital Workbench - Full Atom Feed" />


    </head>
    <body>
        <div id="content">
            <div class="navbar navbar-static-top">
                <div class="navbar-inner">
                    <div class="container-fluid">
                        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </a>
                        <a class="brand" href="https://jackdewinter.github.io/"><span class=site-name>Jack's Digital Workbench</span></a>
                        <div class="nav-collapse collapse">
                            <ul class="nav pull-right top-menu">
                                <li >
                                    <a href=
                                       https://jackdewinter.github.io
                                    >Home</a>
                                </li>
                                <li ><a href="https://jackdewinter.github.io/categories">Categories</a></li>
                                <li ><a href="https://jackdewinter.github.io/tags">Tags</a></li>
                                <li ><a href="https://jackdewinter.github.io/archives">Archives</a></li>
                                <li><form class="navbar-search" action="https://jackdewinter.github.io/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container-fluid">
                <div class="row-fluid">
                    <div class="span1"></div>
                    <div class="span10">
<article itemscope>
<div class="row-fluid">
    <header class="page-header span10 offset2">
        <h1>
            <a href="https://jackdewinter.github.io/2020/09/21/markdown-linter-adding-remaining-inline-tokens/">
                Markdown Linter - Adding Remaining Inline Tokens
            </a>
        </h1>
    </header>
</div>

<div class="row-fluid">
    <div class="span2 table-of-content">
        <nav>
        <h4>Contents</h4>
        <div class="toc">
<ul>
<li><a href="#summary">Summary</a></li>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#what-is-the-audience-for-this-article">What Is the Audience for This Article?</a></li>
<li><a href="#remaining-inline-tokens">Remaining Inline Tokens</a><ul>
<li><a href="#raw-html-and-links">Raw HTML and Links</a><ul>
<li><a href="#testing-and-iterating">Testing and Iterating</a></li>
<li><a href="#new-lines-inside-of-the-token">New Lines Inside of the Token</a></li>
<li><a href="#fixing-newlines">Fixing Newlines</a></li>
<li><a href="#conveying-that-information-back-to-the-caller">Conveying That Information Back to The Caller</a></li>
<li><a href="#adding-validation">Adding Validation</a></li>
<li><a href="#what-about-the-links">What About the Links?</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#autolinks-code-spans-images-and-hard-line-breaks">Autolinks, Code Spans, Images and Hard Line Breaks</a></li>
<li><a href="#last-inline-vs-next-block">Last Inline vs Next Block</a><ul>
<li><a href="#the-other-anchor-for-the-inline-tokens">The Other Anchor for the Inline Tokens</a></li>
<li><a href="#focusing-on-that-line-number">Focusing on That Line Number</a></li>
<li><a href="#completing-the-checks">Completing the Checks</a></li>
</ul>
</li>
<li><a href="#what-was-my-experience-so-far">What Was My Experience So Far?</a></li>
<li><a href="#what-is-next">What is Next?</a></li>
</ul>
</div>
        </nav>
    </div>
    <div class="span8 article-content">
            
            
<h2 id="summary">Summary<a class="headerlink" href="#summary" title="Permanent link">¶</a></h2>
<p>In my
<a href="https://jackdewinter.github.io/2020/09/14/markdown-linter-adding-consistency-checks-for-emphasis-and-text-tokens/">last article</a>,
I completed the addition of proper support for line and column numbers for the
text token and emphasis tokens by finishing the consistency checks.  In this article,
I talk about the efforts and issues required to finish implementing the line and
column numbers for the remaining inline tokens, including their consistency checks.</p>
<h2 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permanent link">¶</a></h2>
<p>From a wholistic point of view, I felt that the accuracy and consistency of the tokens
were getting more solid with each change.  While I expected a fair number of tests to fail
when I started to add the consistency checks, I was now at a point where a failing test
would be a novel thing. And that was good!  But even with that positive outlook on the
project and the consistency checks, I knew I still had a way to go to finish
things up properly with respect to the tokens.</p>
<p>After having finished adding the line/column numbers for the Emphasis tokens and the
Text token, the remaining inline tokens were the only things left in the way of
finishing that work.  After the work
I had done on that group of tokens, I was hoping that this would be an easy batch of
work to complete.  But only time would tell.</p>
<h2 id="what-is-the-audience-for-this-article">What Is the Audience for This Article?<a class="headerlink" href="#what-is-the-audience-for-this-article" title="Permanent link">¶</a></h2>
<p>While detailed more eloquently in
<a href="https://jackdewinter.github.io/2020/04/05/what-is-the-audience-for-my-blog/#what-is-the-audience-for-my-blog">this article</a>,
my goal for this technical article is to focus on the reasoning behind my solutions,
rather that the solutions themselves.  For a full record of the solutions presented in
this article, please go to this project’s GitHub repository and consult the
commits between
<a href="https://github.com/jackdewinter/pymarkdown/commit/f518085e03979439ea20f48a787213f1f145eb3a">04 Sep 2020</a>
and
<a href="https://github.com/jackdewinter/pymarkdown/commit/0d7be8514f459102853974a88810ce6842618e58">09 Sep 2020</a>.</p>
<h2 id="remaining-inline-tokens">Remaining Inline Tokens<a class="headerlink" href="#remaining-inline-tokens" title="Permanent link">¶</a></h2>
<p>Having taken care of the Emphasis tokens and the Text token, all the other inline tokens
remained: Raw-HTML, Links, Images, Autolinks, Code Spans and Hard Line Breaks.
Before starting work on each of these tokens, I was not sure if the effort required
to implement each one would be more like the Emphasis tokens or more like the Text
token.  I hoped it would be a simple case and easy to work on, but there were no
guarantees.</p>
<p>With some optimism in mind, and my fingers crossed, I started my work.</p>
<h3 id="raw-html-and-links">Raw HTML and Links<a class="headerlink" href="#raw-html-and-links" title="Permanent link">¶</a></h3>
<p>As I write this article and look back at my notes, I fully admit that I am a bit
stumped.  Picking one of these two inline tokens to work on makes sense to me.  I have
no notes to myself saying, “two for the price of one” or “these will be simple”.<br/>
I am left scratching my head as to why I decided to work on both at the same time.
Regardless of why I decided to do both, they were both completed.</p>
<p>I believed that working on both items at the same time would just be asking for
something to go wrong, so I chose to focus first on the Raw HTML token.  The initial
change was easy, changing the creation of the token from:</p>
<div class="highlight"><pre><span></span><span class="n">RawHtmlMarkdownToken</span><span class="p">(</span><span class="n">valid_raw_html</span><span class="p">)</span>
</pre></div>
<p>to:</p>
<div class="highlight"><pre><span></span><span class="n">RawHtmlMarkdownToken</span><span class="p">(</span><span class="n">valid_raw_html</span><span class="p">,</span> <span class="n">line_number</span><span class="p">,</span> <span class="n">column_number</span><span class="p">)</span>
</pre></div>
<p>thereby passing the line number and the column number to the constructor for the
<code>RawHtmlMarkdownToken</code> class.  Once that was done, another simple change was made
to the <code>handle_angle_brackets</code> function to pass the current line number and column
number as arguments, as such:</p>
<div class="highlight"><pre><span></span>        <span class="n">new_token</span><span class="p">,</span> <span class="n">after_index</span> <span class="o">=</span> <span class="n">HtmlHelper</span><span class="o">.</span><span class="n">parse_raw_html</span><span class="p">(</span>
            <span class="n">between_brackets</span><span class="p">,</span>
            <span class="n">remaining_line</span><span class="p">,</span>
            <span class="n">inline_request</span><span class="o">.</span><span class="n">line_number</span><span class="p">,</span>
            <span class="n">inline_request</span><span class="o">.</span><span class="n">column_number</span><span class="p">,</span>
        <span class="p">)</span>
</pre></div>
<h4 id="testing-and-iterating">Testing and Iterating<a class="headerlink" href="#testing-and-iterating" title="Permanent link">¶</a></h4>
<p>Running the tests for the Raw HTML token, it was immediately obvious to me that in
certain cases, the column number was off by a bit.  After a bit of research, I noticed
that in cases where there was a Text token before the Raw HTML token, the new Raw HTML
token had the same line/column number as the Text token.  Digging a bit deeper, it
appeared that in those cases, the <code>remaining_line</code> field of the <code>inline_request</code> object
had the correct number of characters to make up the difference, but they were not being
applied.</p>
<p>To address that inadequacy, I made a small change to the above example.  Following the
logic of the inline algorithm, once a new token is created to be inserted, the text
leading up to that token is determined, largely based off the <code>remaining_line</code>
variable.  While this seems slightly out of order, it ensures that the proper Text token
with the proper line/column number is inserted in the correct order.  However, because
the new token is created before that Text token is inserted, it does not have the
right column number.  By simply adding the length of the <code>remaining_line</code> variable to
the column number, the difference is accounted for.  This was accomplished by first
calculating that new column number:</p>
<div class="highlight"><pre><span></span>            <span class="n">new_column_number</span> <span class="o">=</span> <span class="n">inline_request</span><span class="o">.</span><span class="n">column_number</span>
            <span class="n">new_column_number</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">inline_request</span><span class="o">.</span><span class="n">remaining_line</span><span class="p">)</span>
</pre></div>
<p>and then passing that new <code>new_column_number</code> value into the call to the
<code>HtmlHelper.parse_raw_html</code> function in the previous example instead of the
<code>inline_request.column_number</code> argument.</p>
<h4 id="new-lines-inside-of-the-token">New Lines Inside of the Token<a class="headerlink" href="#new-lines-inside-of-the-token" title="Permanent link">¶</a></h4>
<p>After running through the tests again, almost all the tests were passing, except for
the test for
<a href="https://github.github.com/gfm/#example-500">example 500</a>:</p>
<div class="highlight"><pre><span></span><span class="o">[</span><span class="n">link</span><span class="o">]</span><span class="p">(</span><span class="o">&lt;</span><span class="n">foo</span><span class="w"></span>
<span class="n">bar</span><span class="o">&gt;</span><span class="p">)</span><span class="w"></span>
</pre></div>
<p>This case may look weird, but everything is computed properly as a series of Text
tokens and a Raw HTML token.  Because of
the newline in the URI, the text is not eligible to be a link, but since the URI part
is enclosed in “angle brackets”, it is eligible to be a Raw HTML token.  But even with
the Raw HTML token being parsed, the Text token containing the trailing <code>)</code> character was
off.  Instead of being reported as <code>(2,5)</code>, it was being reported as <code>(1,17)</code>.</p>
<p>To investigate this further, I created the new scenario test <code>test_raw_html_634a</code>.  This
new test was a more isolated
case of example 500, a copy of the test function <code>test_raw_html_634</code> with a newline
character inserted inside of the <code>b2</code> HTML tag, as follows:</p>
<div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">a</span>  <span class="o">/&gt;&lt;</span><span class="n">b2</span>
<span class="k">data</span><span class="o">=</span><span class="ss">"foo"</span> <span class="o">&gt;&lt;</span><span class="k">c</span><span class="o">&gt;</span>
</pre></div>
<p>I started to look at this issue and
it turned out to be an easy issue to overcome.</p>
<h4 id="fixing-newlines">Fixing Newlines<a class="headerlink" href="#fixing-newlines" title="Permanent link">¶</a></h4>
<p>With this isolated scenario test, it was very easy to see that the issue was with the
<code>raw_tag</code>
field of the Raw HTML token.  When the token contained a newline character, that newline
was treated as a normal character and added to the character count.  What I needed to
do was to make sure that the algorithm understood that the newline character was special
and to handle it differently.  So, to address that
behavior, I introduced some extra code to the <code>handle_angle_brackets</code> function:</p>
<div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span>
    <span class="n">new_token</span>
    <span class="ow">and</span> <span class="n">new_token</span><span class="o">.</span><span class="n">token_name</span> <span class="o">==</span> <span class="n">MarkdownToken</span><span class="o">.</span><span class="n">token_inline_raw_html</span>
    <span class="ow">and</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span> <span class="ow">in</span> <span class="n">new_token</span><span class="o">.</span><span class="n">raw_tag</span>
<span class="p">):</span>
    <span class="n">split_raw_tag</span> <span class="o">=</span> <span class="n">new_token</span><span class="o">.</span><span class="n">raw_tag</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">inline_response</span><span class="o">.</span><span class="n">delta_line_number</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">split_raw_tag</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">length_of_last_elements</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">split_raw_tag</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">inline_response</span><span class="o">.</span><span class="n">delta_column_number</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">length_of_last_elements</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">inline_response</span><span class="o">.</span><span class="n">delta_column_number</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">inline_response</span><span class="o">.</span><span class="n">new_index</span> <span class="o">-</span> <span class="n">inline_request</span><span class="o">.</span><span class="n">next_index</span>
    <span class="p">)</span>
<span class="k">return</span> <span class="n">inline_response</span>
</pre></div>
<p>Basically, since the existing code already handled the case with zero newlines perfectly,
I did not need to change that aspect of the function.  However, in the case of a Raw HTML
token that contained a newline in its <code>raw_tag</code> field, I needed special processing to
kick in.  The first thing I
needed was a clear picture of the <code>raw_tag</code> field and its newline characters, so I
split the string on newline characters into the <code>split_raw_tag</code> variable.  Then I
addressed the line number calculation first, correcting the line number calculation by
adding the number of newline characters found to the <code>inline_response.delta_line_number</code>
variable.<sup id="fnref:splitLine"><a class="footnote-ref" href="#fn:splitLine">1</a></sup></p>
<p>After I was sure that the line number was being correctly calculated, it was time for me
to focus on the column number.  While each of the lines in the <code>raw_tag</code> field were
important, their content was already mostly covered by the calculation for the change to
the line number.  Each line except the last line that is.  That last line was the new
information that would lead the text after the Raw HTML token.  As such, the column
number was at least as many characters along as the length of any text past that last
newline character, as calculated for the <code>length_of_last_elements</code> variable.  With
that calculation completed, all that was required was to add 2 to that value for
constant element overhead: 1 for
the length of the closing angle brackets (<code>&gt;</code>) and 1 to translate the value from an
index to a position.<sup id="fnref:indexPosition"><a class="footnote-ref" href="#fn:indexPosition">2</a></sup></p>
<h4 id="conveying-that-information-back-to-the-caller">Conveying That Information Back to The Caller<a class="headerlink" href="#conveying-that-information-back-to-the-caller" title="Permanent link">¶</a></h4>
<p>With everything else completed, I then had to decide how I was going to get the newly
calculated column number back to the calling function.  According to the debug
statements that I had added, the value was being calculated properly.  While there were
a couple of options on the table, I decided to go for a simple approach: a negative
number.</p>
<p>I am not sure if this choice is
<a href="https://blog.startifact.com/posts/older/what-is-pythonic.html">pythonic</a>
or not, I believe that it conveys the right information in an efficient manner.
If the column number is zero or positive, it represents a simple change or delta to the
column
number, a simple value to be added to the current column number to arrive at the new
column number.  However, if the column number is negative, it represents an absolute
number that should be used for the column number.  For example, if the token contains
a newline character, it makes sense that the returned value would indicate a value
from the start of the new line, not from the last know position.</p>
<p>Why a negative number?  While I could have returned an extra value that determined
whether the number was referential or absolute, that seemed too bulky.  For me, this
was keeping it lean within its limited scope.</p>
<h4 id="adding-validation">Adding Validation<a class="headerlink" href="#adding-validation" title="Permanent link">¶</a></h4>
<p>After all that work, the validation was very anti-climactic.  It may appear that I
cheated and copied the calculation from above as-is into the new
<code>__verify_next_inline_raw_html</code> function.  Rather than being a cheat, I worked
through the calculations again on paper, making sure that I did not miss any weird
boundary conditions.  After generating the algorithm in the
<code>__verify_next_inline_raw_html</code> function from scratch, I compared the two algorithms
together and the algorithms themselves were the same.  Rather than cheating,
I considered it a validation that I had derived the right algorithm twice.</p>
<h4 id="what-about-the-links">What About the Links?<a class="headerlink" href="#what-about-the-links" title="Permanent link">¶</a></h4>
<p>As I mentioned at the start of this section, I am not sure why I decided to work on
these two tokens together.  I can only guess that perhaps
I thought that adding line/column numbers to the Link tokens would uncover something
important that adding line/column numbers to the Raw HTML tokens would not.
The reality was that after completing the Raw HTML token work, the changes needed
to implement the line/column numbers for Link tokens was trivially easy.</p>
<p>Unexpectantly, this would foreshadow the following work on the other inline tokens.</p>
<h2 id="autolinks-code-spans-images-and-hard-line-breaks">Autolinks, Code Spans, Images and Hard Line Breaks<a class="headerlink" href="#autolinks-code-spans-images-and-hard-line-breaks" title="Permanent link">¶</a></h2>
<p>I expected some manner of difficulty in implementing the line/column numbers
for these tokens, however the previous work made the implementation of the new code easy.
There were issues that needed to be properly addressed for each specific type of
token, but the hard work had already been done.  As such, the work was more akin
to copy-and-paste-and-adjust than anything else.</p>
<p>In the implementation of each of the tokens, the initial calculation for each of the
tokens included values for the length of the constant part of the element and the
variable part of
the element.  Once that was complete and the easy tests were passing, any multiline
parts were addressed, with progress being made to get closer to having the remaining
scenario tests passing.  To finish that work, consistency checks were added that were
simply verifying the algorithms used previous and verifying the work.</p>
<p>This process was a simple rehash of the work that I did for the Raw HTML token, and
then again for the Link token.  But it was working and working well.  While a part
of me was saying “this is too easy, what’s wrong?”, I double checked all my work
to quiet that voice and assure myself that I had not missed anything.</p>
<p>While it was simple work, it did take a couple of days to complete.  But at the end
of that work, each relevant token had a line number and a column number, and they
had been verified.  Even more interesting, while some extra scenarios were added to
deal with missing cases (mostly to deal with multiline element parts), no new issues
had been found.  Things were looking good.  Almost.</p>
<h2 id="last-inline-vs-next-block">Last Inline vs Next Block<a class="headerlink" href="#last-inline-vs-next-block" title="Permanent link">¶</a></h2>
<p>With all the inline tokens supporting line/column numbers, I felt as if a bit of
a load was taken off of my shoulders.  I was not really worried that there was something
wrong, but as I mentioned
<a href="https://jackdewinter.github.io/2020/09/14/markdown-linter-adding-consistency-checks-for-emphasis-and-text-tokens/#introduction">in the last article</a>:</p>
<blockquote>
<p>I know that I am fallible.</p>
</blockquote>
<p>There was no proof that I could see that I had missed something, but I just had a
nagging feeling that I had left something out.  Trying to get rid of that feeling, I went
through the work that I had just completed and checked it again, finding nothing out
of the ordinary.  On top of that, I had automation in place to catch any miscalculations
that I made, something that was welcome.</p>
<p>After that extra checking was completed, I could not find anything wrong and I was ready
to move on.  But as I was getting ready to start working on some of the items
in the issue list, I noticed something.  Reading my previous article to gain some
extra perspective on where I was in the project, I noticed the part where I stated:</p>
<blockquote>
<p>So, whether I liked the idea or not, validation of the first element in the list was mandatory.  The last element is a different story.  While it would be nice to tie the last inline token to the following block token, I felt that it was not as important as the verification of the first element.  However, I added in a placeholder to the code to make sure that I would follow up on it later.</p>
</blockquote>
<p>I remembered!</p>
<h3 id="the-other-anchor-for-the-inline-tokens">The Other Anchor for the Inline Tokens<a class="headerlink" href="#the-other-anchor-for-the-inline-tokens" title="Permanent link">¶</a></h3>
<p>As I mentioned before, I started with the outer token and the first token because
I wanted to ensure that was able to anchor the list, and the anchoring the first token
was the easiest solution at the time.  Having finished that task off and
also having finished validation of the inline tokens within the list, it was now time to
work on anchoring the other side of the list: the last inline token and the following
block token.  That is what the nagging feeling was! That is what I was trying to
remember.</p>
<p>Starting to research what I needed to do to resolve this anchor issue, I came to an
interesting
observation.  While all groups of inline tokens start after a block token, not all
groups of inline tokens end with a block token.  Because of the way tokenization is
performed, I decided not to expose line/column numbers for any of the end tokens that
did not add something to the data stream.  This means that except for the
Emphasis end token, none of the other end tokens have a line/column associated with
them.</p>
<p>Why is that observation on tokenization important?  A good example is the Markdown
document for
<a href="https://github.github.com/gfm/#example-364">example 364</a>:</p>
<div class="highlight"><pre><span></span><span class="n">foo</span><span class="o">*</span><span class="n">bar</span><span class="o">*</span>
</pre></div>
<p>From that Markdown,
I can surmise that the tokens for that document will start with a Paragraph
start token and end with a Paragraph end token.  Inside of the paragraph, there will be
a Text token containing <code>foo</code>, an Emphasis start token, a Text token containing <code>bar</code>,
and an Emphasis end token.  This is backed up by the realized tokens for the example,
which are:</p>
<div class="highlight"><pre><span></span>    <span class="n">expected_tokens</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">"[para(1,1):]"</span><span class="p">,</span>
        <span class="s2">"[text(1,1):foo:]"</span><span class="p">,</span>
        <span class="s2">"[emphasis(1,4):1:*]"</span><span class="p">,</span>
        <span class="s2">"[text(1,5):bar:]"</span><span class="p">,</span>
        <span class="s2">"[end-emphasis(1,8)::1:*:False]"</span><span class="p">,</span>
        <span class="s2">"[end-para:::True]"</span><span class="p">,</span>
    <span class="p">]</span>
</pre></div>
<p>From looking at this tokenization, the last token with a line/column number attached
to it is the Emphasis end token, an inline token.  Getting an actual block token to
appear after those tokens is as simple as changing the Markdown to:</p>
<div class="highlight"><pre><span></span><span class="n">foo</span><span class="o">*</span><span class="n">bar</span><span class="o">*</span>
</pre></div>
<p>This adds a new Blank Line token to the end of the array, adding the tokenization
<code>'[BLANK(2,1):]'</code>.  However, I knew the real trick would be to determine that value
without having to add that extra token.</p>
<h3 id="focusing-on-that-line-number">Focusing on That Line Number<a class="headerlink" href="#focusing-on-that-line-number" title="Permanent link">¶</a></h3>
<p>Working through the issue from the previous section helped me understand something
else about the relationship with the last inline token and the possible following
block token: only the line number was important.  Because the inline tokens
are always contained within a container block element or a leaf block element, the
last token in an inline token group is guaranteed to be either an end token for a
previously started block element or a start token for a new block element.</p>
<p>If the next block token after the inline tokens is a block start token, because of
the work up to this point, a line/column number is guaranteed.  If the next block
token is a block end token, one of two things happens.  Either a block start token
follows with the start of a new block element, or the end of the document is reached.
If a block start token follows, the line/column number is guaranteed as above.
In the case of the end of the document, as no token with a valid line/column number
follows, some other calculation is needed to determine the line number to compare
to.</p>
<p>The good news is that only the line number is important.  Because only the line number
is important, there is another available number that we can use: the number of lines
in the Markdown document.  As such, if there is a block start token after the inline
block, I used the line number from that token as the line number to compare against.
If no such token existed, I used the number of lines in the document.</p>
<p>I tested this approach with a handful of scenarios, some with eligible following block
tokens and some with an absence of eligible following block tokens.  On paper it seemed
to work without fail.  The only thing that was left was to test that approach with
actual code.</p>
<h3 id="completing-the-checks">Completing the Checks<a class="headerlink" href="#completing-the-checks" title="Permanent link">¶</a></h3>
<p>To calculate the line number to compare to, I added the <code>__verify_last_inline</code>
function with my usual development pattern.  Following that pattern, I started
adding handlers for each of the inline tokens it encountered, just trying to
get to a steady state where all the handlers were present.  Once that was achieved,
I started adding the content to each handler to calculate the height of the inline
token.</p>
<p>Now I wish I could say it was good planning, but it was just serendipity that I
did this work right after the work on adding the line/column number support to most
of the inline tokens.  Based on that recent work, adding the calculations for the
heights of each of the tokens was exceedingly easy.  While it was easy, it took
a couple of days for me to work through each case and verify each twist and turn
of the token.  But in the end, with only one planned failure<sup id="fnref:IKnew"><a class="footnote-ref" href="#fn:IKnew">3</a></sup> to address and
one or two items to look at later, the token validation was complete!</p>
<h2 id="what-was-my-experience-so-far">What Was My Experience So Far?<a class="headerlink" href="#what-was-my-experience-so-far" title="Permanent link">¶</a></h2>
<p>Getting to this point in the PyMarkdown project was a momentous achievement for
me, measured in months rather than days.  Along the way, I had developed a
Markdown parser, ensured that it emitted tokens that include line numbers and
column numbers, verified its output against both expected HTML output and the original
Markdown input, and had a good array of consistency checks on the line numbers and
column numbers.  Phew.  It was a long list, but the project has come a long way.</p>
<p>I was relieved that I got to this point with my original design mostly intact.  I
was aware that I was going to have to do some refactoring in the future to make the
code more modifiable, but I believe it is in a decent position to make that happen.
Besides, when I start doing that, I have almost 1400 scenario tests that will make
sure any changes are not negatively impacting the code.</p>
<p>With all that good stuff in mind, I started to look at the issues list, and paged
through it.  At just over 200 lines of text, it was a bit daunting to look at initially.
But as I progressed with the project, any idea or question I had was put into that
list.  There were ideas for better tests, questions on whether something was done right,
and notes on things I wanted to check because they looked weird in some way.  And during
the project’s development to date, I had taken proactive efforts to get any
serious issues out of the way.  Being the optimistic, I hoped that I was left with a
solid set of enhancements.  Regardless
of what remained in the list, I was sure that I could tackle it.  And sure, there
might be some rewrites that I would need to do, but they would make the project stronger,
leaner, faster, and more maintainable.</p>
<p>So how was I feeling?  Very optimistic.  There were quite the number of items in the
issues list, but if I tackled them one at I time, I could get through them.  And going
through them would either fix an issue or confirm that the project did not have that
particular issue.  And to me, both outcomes were positive.</p>
<h2 id="what-is-next">What is Next?<a class="headerlink" href="#what-is-next" title="Permanent link">¶</a></h2>
<p>Having completed all the consistency checks, I now had operating scenario tests with
values and line/column numbers that I was very confident about.  But along the way,
I had accumulated a decent number of items in the issues list.  Before getting back
to filling out the set of rules, it was time to address those items.</p>
<div class="footnote">
<hr/>
<ol>
<li id="fn:splitLine">
<p>Python’s <code>split</code> function works as expected.  If you have a string that does not contain the sequence to split on, it returns an array with one element.  If you have a string that has one or more instances of the sequence to split on, it returns an array with each element being any text between those instances.  As such, if a string has one newline character and is split, it will result in an array with a length of 2.  Therefore, I used <code>len(split_raw_tag) - 1</code> to figure out the number of newline characters found in the <code>raw_tag</code> field. <a class="footnote-backref" href="#fnref:splitLine" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
<li id="fn:indexPosition">
<p>By their nature, an index starts at 0 and a position starts at 1.  As a column number is a position on a line but was being computed as an index, I needed to add 1 to the value to transition it into being a position. <a class="footnote-backref" href="#fnref:indexPosition" title="Jump back to footnote 2 in the text">↩</a></p>
</li>
<li id="fn:IKnew">
<p>Ahead of time, I had already determined that the scenario test <code>test_inline_links_518b</code> was split over multiple lines and would be addressed by this validation. <a class="footnote-backref" href="#fnref:IKnew" title="Jump back to footnote 3 in the text">↩</a></p>
</li>
</ol>
</div>


             
 
                <p id="post-share-links">
    Like this post? Share on:
    <a href="https://twitter.com/intent/tweet?text=Markdown%20Linter%20-%20Adding%20Remaining%20Inline%20Tokens&url=https%3A//jackdewinter.github.io/2020/09/21/markdown-linter-adding-remaining-inline-tokens/&hashtags=markdown-linter,core-linter" target="_blank" rel="nofollow noopener noreferrer" title="Share on Twitter">Twitter</a>
    ❄
    <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A//jackdewinter.github.io/2020/09/21/markdown-linter-adding-remaining-inline-tokens/" target="_blank" rel="nofollow noopener noreferrer" title="Share on Facebook">Facebook</a>
    ❄
    <a href="mailto:?subject=Markdown%20Linter%20-%20Adding%20Remaining%20Inline%20Tokens&amp;body=https%3A//jackdewinter.github.io/2020/09/21/markdown-linter-adding-remaining-inline-tokens/" target="_blank" rel="nofollow noopener noreferrer" title="Share via Email">Email</a>
    </p>

            
            






<section>
    <h6 style="display:none;">Comments</h6>
    <p id="comment-message">So what do you think? Did I miss something? Is any part unclear? Leave your comments below. </p>

    <div class="accordion" id="accordion2">
        <div class="accordion-group">
            <div class="accordion-heading">
                <a class="accordion-toggle disqus-comment-count comment-count"
                   data-toggle="collapse"
                   data-parent="#accordion2"
                   href="https://jackdewinter.github.io/2020/09/21/markdown-linter-adding-remaining-inline-tokens/#comment_thread"
                   id="comment-accordion-toggle">
                    Comments
                </a>
            </div>
            <div id="comment_thread" class="accordion-body collapse">
                <div class="accordion-inner">
                    <div class="comments">

                        <script src="https://utteranc.es/client.js"
        data-repo="jackdewinter/jackdewinter.github.io"
        data-issue-term="markdown-linter-adding-remaining-inline-tokens"
        data-label="Comments"
        data-theme="github-light"
        crossorigin="anonymous"
        async>
</script>

                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

            <hr/>
            <aside>
            <nav>
            <ul class="articles-timeline">
                <li class="previous-article">« <a href="https://jackdewinter.github.io/2020/09/14/markdown-linter-adding-consistency-checks-for-emphasis-and-text-tokens/" title="Previous: Markdown Linter - Adding Consistency Checks for Emphasis and Text Tokens">Markdown Linter - Adding Consistency Checks for Emphasis and Text Tokens</a></li>
                <li class="next-article"><a href="https://jackdewinter.github.io/2020/09/28/markdown-linter-delving-into-the-issues-1/" title="Next: Markdown Linter - Delving Into the Issues - 1">Markdown Linter - Delving Into the Issues - 1</a> »</li>
            </ul>
            </nav>
            </aside>
        </div>
        <section id="article-sidebar" class="span2">
    <h4>Reading Time</h4>
    <p>~15 min read</p>
            <h4>Published</h4>
            <time itemprop="dateCreated" datetime="2020-09-21T00:00:00-07:00">Sep 21, 2020</time>
        <h4>Markdown Linter Core</h4>
    <ul class="multi-parts-list">
            <li >
            <a href="https://jackdewinter.github.io/2020/05/04/markdown-linter-core-pre-rule-improvements/" title="Markdown Linter - Core - Pre-Rule Improvements">Part 1: Markdown Linter - Core - Pre-Rule Improvements</a>
            </li>
            <li >
            <a href="https://jackdewinter.github.io/2020/06/01/markdown-linter-taking-time-to-evaluate/" title="Markdown Linter - Taking Time To Evaluate">Part 2: Markdown Linter - Taking Time To Evaluate</a>
            </li>
            <li >
            <a href="https://jackdewinter.github.io/2020/06/08/markdown-linter-adding-line-and-column-support/" title="Markdown Linter - Adding Line and Column Support">Part 3: Markdown Linter - Adding Line and Column Support</a>
            </li>
            <li >
            <a href="https://jackdewinter.github.io/2020/06/15/markdown-linter-rabbit-hole-1-adding-consistency-checks/" title="Markdown Linter - Rabbit Hole 1 - Adding Consistency Checks">Part 4: Markdown Linter - Rabbit Hole 1 - Adding Consistency Checks</a>
            </li>
            <li >
            <a href="https://jackdewinter.github.io/2020/06/22/markdown-linter-rabbit-hole-2-losing-my-way/" title="Markdown Linter - Rabbit Hole 2 - Losing My Way">Part 5: Markdown Linter - Rabbit Hole 2 - Losing My Way</a>
            </li>
            <li >
            <a href="https://jackdewinter.github.io/2020/07/06/markdown-linter-weeding-the-projects-issue-list/" title="Markdown Linter - Weeding the Project's Issue List">Part 6: Markdown Linter - Weeding the Project's Issue List</a>
            </li>
            <li >
            <a href="https://jackdewinter.github.io/2020/06/29/markdown-linter-rabbit-hole-3-trying-to-dig-myself-out/" title="Markdown Linter - Rabbit Hole 3 - Trying To Dig Myself Out">Part 7: Markdown Linter - Rabbit Hole 3 - Trying To Dig Myself Out</a>
            </li>
            <li >
            <a href="https://jackdewinter.github.io/2020/07/13/markdown-linter-improving-consistency/" title="Markdown Linter - Improving Consistency">Part 8: Markdown Linter - Improving Consistency</a>
            </li>
            <li >
            <a href="https://jackdewinter.github.io/2020/07/20/markdown-linter-transforming-back-to-markdown/" title="Markdown Linter - Transforming Back to Markdown">Part 9: Markdown Linter - Transforming Back to Markdown</a>
            </li>
            <li >
            <a href="https://jackdewinter.github.io/2020/07/27/markdown-linter-addressing-the-initial-markdown-transformer-issues/" title="Markdown Linter - Addressing the Initial Markdown Transformer Issues">Part 10: Markdown Linter - Addressing the Initial Markdown Transformer Issues</a>
            </li>
            <li >
            <a href="https://jackdewinter.github.io/2020/08/03/markdown-linter-improving-the-markdown-transformer/" title="Markdown Linter - Improving the Markdown Transformer">Part 11: Markdown Linter - Improving the Markdown Transformer</a>
            </li>
            <li >
            <a href="https://jackdewinter.github.io/2020/08/10/markdown-linter-adding-links-to-the-markdown-transformer/" title="Markdown Linter - Adding Links to the Markdown Transformer">Part 12: Markdown Linter - Adding Links to the Markdown Transformer</a>
            </li>
            <li >
            <a href="https://jackdewinter.github.io/2020/08/17/markdown-linter-adding-lists-to-the-markdown-transformer/" title="Markdown Linter - Adding Lists to the Markdown Transformer">Part 13: Markdown Linter - Adding Lists to the Markdown Transformer</a>
            </li>
            <li >
            <a href="https://jackdewinter.github.io/2020/08/25/markdown-linter-adding-consistency-to-block-quotes/" title="Markdown Linter - Adding Consistency to Block Quotes">Part 14: Markdown Linter - Adding Consistency to Block Quotes</a>
            </li>
            <li >
            <a href="https://jackdewinter.github.io/2020/08/31/markdown-linter-adding-consistency-to-token-heights/" title="Markdown Linter - Adding Consistency to Token Heights">Part 15: Markdown Linter - Adding Consistency to Token Heights</a>
            </li>
            <li >
            <a href="https://jackdewinter.github.io/2020/09/07/markdown-linter-starting-to-add-linecolumn-numbers-for-inline-tokens/" title="Markdown Linter - Starting to Add Line/Column Numbers For Inline Tokens">Part 16: Markdown Linter - Starting to Add Line/Column Numbers For Inline Tokens</a>
            </li>
            <li >
            <a href="https://jackdewinter.github.io/2020/09/14/markdown-linter-adding-consistency-checks-for-emphasis-and-text-tokens/" title="Markdown Linter - Adding Consistency Checks for Emphasis and Text Tokens">Part 17: Markdown Linter - Adding Consistency Checks for Emphasis and Text Tokens</a>
            </li>
            <li  class="active-part">
            Part 18: Markdown Linter - Adding Remaining Inline Tokens
            </li>
    </ul>
            <h4>Category</h4>
            <a class="category-link" href="https://jackdewinter.github.io/categories#software-quality-ref">Software Quality</a>
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article">
                <li><a href="https://jackdewinter.github.io/tags#core-linter-ref">core linter
                    <span>69</span>
</a></li>
                <li><a href="https://jackdewinter.github.io/tags#markdown-linter-ref">markdown linter
                    <span>87</span>
</a></li>
            </ul>
<h4>Stay in Touch</h4>
<div id="sidebar-social-link">
    <a href="https://github.com/jackdewinter" title="github-alt" target="_blank" rel="nofollow noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="GitHub" role="img" viewBox="0 0 512 512"><rect width="512" height="512" rx="15%" fill="#1B1817"/><path fill="#fff" d="M335 499c14 0 12 17 12 17H165s-2-17 12-17c13 0 16-6 16-12l-1-50c-71 16-86-28-86-28-12-30-28-37-28-37-24-16 1-16 1-16 26 2 40 26 40 26 22 39 59 28 74 22 2-17 9-28 16-35-57-6-116-28-116-126 0-28 10-51 26-69-3-6-11-32 3-67 0 0 21-7 70 26 42-12 86-12 128 0 49-33 70-26 70-26 14 35 6 61 3 67 16 18 26 41 26 69 0 98-60 120-117 126 10 8 18 24 18 48l-1 70c0 6 3 12 16 12z"/></svg>
    </a>
    <a href="https://www.linkedin.com/in/jackdewinter/" title="linkedin" target="_blank" rel="nofollow noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="LinkedIn" role="img" viewBox="0 0 512 512" fill="#fff"><rect width="512" height="512" rx="15%" fill="#0077b5"/><circle cx="142" cy="138" r="37"/><path stroke="#fff" stroke-width="66" d="M244 194v198M142 194v198"/><path d="M276 282c0-20 13-40 36-40 24 0 33 18 33 45v105h66V279c0-61-32-89-76-89-34 0-51 19-59 32"/></svg>
    </a>
    <a href="https://jackdewinter.github.io/feeds/all.atom.xml" title="" target="_blank" rel="nofollow noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="RSS" role="img" viewBox="0 0 512 512"><rect width="512" height="512" rx="15%" fill="#f80"/><circle cx="145" cy="367" r="35" fill="#fff"/><path fill="none" stroke="#fff" stroke-width="60" d="M109 241c89 0 162 73 162 162M109 127c152 0 276 124 276 276"/></svg>
    </a>
</div>
            





            





        </section>
</div>
</article>
                    </div>
                    <div class="span1"></div>
                </div>
            </div>
        </div>
<footer>
    <div>
        
&copy; Copyright 2021 by Jack De Winter and licensed under a <a rel="license"
  href="http://creativecommons.org/licenses/by/4.0/">
  <img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/80x15.png" />
  Creative Commons Attribution 4.0 International License</a>.

    </div>




    <div id="fpowered">
        Powered by: <a href="http://getpelican.com/" title="Pelican Home Page" target="_blank" rel="nofollow noopener noreferrer">Pelican</a>
        Theme: <a href="https://elegant.oncrashreboot.com/" title="Theme Elegant Home Page" target="_blank" rel="nofollow noopener noreferrer">Elegant</a>
    </div>
</footer>            <script src="//code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

    <script>
    (function () {
        if (window.location.hash.match(/^#comment-\d+$/)) {
            $('#comment_thread').collapse('show');
        }
    })();
    window.onhashchange=function(){
        if (window.location.hash.match(/^#comment-\d+$/))
            window.location.reload(true);
    }
    $('#comment_thread').on('shown', function () {
        var link = document.getElementById('comment-accordion-toggle');
        var old_innerHTML = link.innerHTML;
        $(link).fadeOut(200, function() {
            $(this).text('Click here to hide comments').fadeIn(200);
        });
        $('#comment_thread').on('hidden', function () {
            $(link).fadeOut(200, function() {
                $(this).text(old_innerHTML).fadeIn(200);
            });
        })
    })
</script>

    </body>
    <!-- Theme: Elegant built for Pelican
        License : MIT -->
</html>